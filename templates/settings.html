{% extends "layout.html" %}

{% block title %}カスタマイズ - {{ super() }}{% endblock %}

{% block page_header %}
    <h1 class="text-xl font-semibold text-slate-800">チャットボット設定</h1>
{% endblock %}

{% block content %}
<style>
    /* ツールチップのためのCSS */
    .tooltip-container {
        position: relative;
        display: inline-flex;
        align-items: center;
    }
    .tooltip-icon {
        margin-left: 8px;
        color: #94a3b8; /* slate-400 */
        cursor: pointer;
    }
    .tooltip-text {
        visibility: hidden;
        width: 250px;
        background-color: #1e293b; /* slate-800 */
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -125px; /* widthの半分 */
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: normal;
    }
    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
    }
    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-2 bg-white p-8 rounded-xl shadow-md">
        <form method="POST">
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">基本設定</h3>
                <div class="mb-6">
                    <label for="bot_name" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>ボットの名前</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">チャット画面のヘッダーや、AIの自己紹介で使われる名前です。</span>
                        </div>
                    </label>
                    <input type="text" id="bot_name" name="bot_name" value="{{ data.bot_name }}" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="mb-6">
                    <label for="welcome_message" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>歓迎メッセージ</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">ユーザーがチャットを開始した時に、最初に表示されるメッセージです。</span>
                        </div>
                    </label>
                    <textarea id="welcome_message" name="welcome_message" rows="4" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">{{ data.welcome_message }}</textarea>
                </div>
                <div>
                    <label for="uncertain_reply" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>不明な質問への応答</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">AIがユーザーの質問に答えられない場合に、このメッセージを返します。</span>
                        </div>
                    </label>
                    <textarea id="uncertain_reply" name="uncertain_reply" rows="4" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">{{ data.uncertain_reply }}</textarea>
                </div>
                </div>

            <div>
                <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">デザイン設定</h3>
                <div class="mb-6">
                    <label for="header_color" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>ヘッダーの色</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">Webチャット画面の上部の色を選択します。</span>
                        </div>
                    </label>
                    <div class="flex items-center">
                        <input type="color" id="header_color" name="header_color" value="{{ data.header_color }}" class="h-10 w-10 p-1 border rounded-lg cursor-pointer">
                        <input type="text" id="color-code-text" value="{{ data.header_color }}" class="ml-3 font-mono text-slate-700 w-24 border-b">
                    </div>
                </div>
            </div>

            <div class="mt-8 border-t pt-8">
                <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">LINE公式アカウント連携</h3>
                <p class="text-slate-500 text-sm mb-4">
                    ご自身で作成したLINE公式アカウントの認証情報を入力してください。
                    <a href="https://developers.line.biz/ja/docs/messaging-api/getting-started/" target="_blank" class="text-sky-600 hover:underline">取得方法はこちら</a>
                </p>
                
                <div class="mb-6">
                    <label for="line_channel_token" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>チャネルアクセストークン (長期)</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">LINE Developersコンソールで発行される、ボットがユーザーにメッセージを送るために必要な長い文字列のキーです。</span>
                        </div>
                    </label>
                    <input type="password" id="line_channel_token" name="line_channel_token" value="{{ data.line_channel_token or '' }}" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                
                <div class="mb-6">
                    <label for="line_channel_secret" class="block text-slate-700 text-sm font-bold mb-2">
                         <div class="tooltip-container">
                            <span>チャネルシークレット</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">LINEプラットフォームからの通信が正当なものであることを確認するために使用されるキーです。LINE Developersコンソールで確認できます。</span>
                        </div>
                    </label>
                    <input type="password" id="line_channel_secret" name="line_channel_secret" value="{{ data.line_channel_secret or '' }}" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
            </div>
            
            <div class="mt-8 border-t pt-8">
                <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">通知設定</h3>
                <div class="mb-6">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" name="enable_weekly_report" value="true" {% if data.enable_weekly_report %}checked{% endif %} class="h-5 w-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500">
                        <span class="text-slate-700 font-medium">週次レポートメールを有効にする</span>
                    </label>
                </div>
                
                <div>
                    <label for="report_day_of_week" class="block text-slate-700 text-sm font-bold mb-2">
                        <div class="tooltip-container">
                            <span>レポートを受信する曜日</span>
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text">毎週指定した曜日に、チャットボットの利用状況レポートがメールで届きます。</span>
                        </div>
                    </label>
                    <select id="report_day_of_week" name="report_day_of_week" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <option value="0" {% if data.report_day_of_week == 0 %}selected{% endif %}>日曜日</option>
                        <option value="1" {% if data.report_day_of_week == 1 %}selected{% endif %}>月曜日</option>
                        <option value="2" {% if data.report_day_of_week == 2 %}selected{% endif %}>火曜日</option>
                        <option value="3" {% if data.report_day_of_week == 3 %}selected{% endif %}>水曜日</option>
                        <option value="4" {% if data.report_day_of_week == 4 %}selected{% endif %}>木曜日</option>
                        <option value="5" {% if data.report_day_of_week == 5 %}selected{% endif %}>金曜日</option>
                        <option value="6" {% if data.report_day_of_week == 6 %}selected{% endif %}>土曜日</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 text-right">
                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg focus:outline-none focus:shadow-outline transition-colors shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i> 保存する
                </button>
            </div>
        </form>
    </div>

    <div class="lg:col-span-1">
        <div class="sticky top-8">
            <h3 class="text-lg font-bold mb-2 text-slate-700">ライブプレビュー</h3>
            <div class="w-full max-w-sm mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
                <div id="preview-header" class="p-3 text-white font-bold text-center transition-colors" style="background-color: {{ data.header_color }};">
                    <span id="preview-bot-name">{{ data.bot_name }}</span>
                </div>
                <div class="p-4 bg-slate-50 h-64 flex flex-col">
                    <div id="preview-welcome-message" class="bg-slate-200 text-slate-800 text-sm p-2 rounded-lg self-start max-w-xs break-words">
                        {{ data.welcome_message }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const botNameInput = document.getElementById('bot_name');
    const welcomeMessageInput = document.getElementById('welcome_message');
    const colorPicker = document.getElementById('header_color');
    const colorCodeText = document.getElementById('color-code-text');
    
    const previewBotName = document.getElementById('preview-bot-name');
    const previewWelcomeMessage = document.getElementById('preview-welcome-message');
    const previewHeader = document.getElementById('preview-header');

    botNameInput.addEventListener('input', (e) => {
        previewBotName.textContent = e.target.value;
    });

    welcomeMessageInput.addEventListener('input', (e) => {
        previewWelcomeMessage.textContent = e.target.value;
    });
    
    colorPicker.addEventListener('input', (e) => {
        const color = e.target.value;
        previewHeader.style.backgroundColor = color;
        colorCodeText.value = color;
    });

    colorCodeText.addEventListener('input', (e) => {
        const color = e.target.value;
        if (/^#[0-9A-F]{6}$/i.test(color)) {
            previewHeader.style.backgroundColor = color;
            colorPicker.value = color;
        }
    });
</script>
{% endblock %}